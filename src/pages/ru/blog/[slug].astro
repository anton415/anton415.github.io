---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Giscus from '../../../components/Giscus.astro';
import { getCollection } from 'astro:content';
import { buildSlugMapById, slugifyTag } from '../../../i18n/alternatePaths';

export async function getStaticPaths() {
  const posts = await getCollection('postsRu');
  const postsEn = await getCollection('posts');
  const postSlugMap = buildSlugMapById(posts, postsEn);

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: {
      post,
      switchToEnPath: `/blog/${postSlugMap.get(post.slug) ?? post.slug}`,
    },
  }));
}

const { post, switchToEnPath } = Astro.props;
const { Content } = await post.render();

const formattedDate = post.data.date.toLocaleDateString('ru-RU', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const tagLinks = [];
const seenTags = new Set();
for (const tag of post.data.tags ?? []) {
  const slug = slugifyTag(tag);
  if (!slug || seenTags.has(slug)) continue;
  seenTags.add(slug);
  tagLinks.push({ label: tag, slug });
}
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  image={post.data.socialImage}
  ogType="article"
  locale="ru"
  switchToEnPath={switchToEnPath}
>
  <article class="card post">
    <p class="pill">{formattedDate}</p>
    <div class="meta-row">
      {tagLinks.length ? (
        <div class="tag-list" aria-label="Теги">
          {tagLinks.map((tag) => (
            <a class="tag-chip" href={`/ru/blog/tags/${tag.slug}`}>
              {tag.label}
            </a>
          ))}
        </div>
      ) : null}
      {post.data.readingTime ? (
        <span class="meta">{post.data.readingTime}</span>
      ) : null}
    </div>
    <h1>{post.data.title}</h1>
    <p class="lede">{post.data.description}</p>
    <Content />
    <Giscus
      lang="ru"
      title="Комментарии"
      ariaLabel="Комментарии"
      fallbackText="Комментарии работают через GitHub Discussions. Укажите"
      fallbackEnableText="чтобы включить комментарии."
    />
  </article>
</BaseLayout>

<style>
  .post h1 {
    margin-top: 0.7rem;
  }

  .lede {
    font-size: 1.1rem;
    color: #4d4235;
  }

  .meta-row {
    margin: 0.75rem 0 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }

  .meta {
    font-size: 0.8rem;
    color: #5a5041;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    border: 1px solid rgba(61, 40, 20, 0.2);
    background: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
    color: #4d4235;
    transition: border-color 0.2s ease, color 0.2s ease;
  }

  .tag-chip:hover {
    border-color: #c35b2d;
    color: #c35b2d;
  }

  .post :global(p) {
    line-height: 1.7;
  }
</style>
