---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { profile } from '../data/profile';
import { cv } from '../data/cv';
import { socialLinks } from '../data/links';

const posts = await getCollection('posts');
const featuredPosts = posts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 2);

const projects = await getCollection('projects');
const featuredProjects = [...projects]
  .sort((a, b) => a.data.title.localeCompare(b.data.title))
  .slice(0, 2);

const featuredLinks = socialLinks.filter((link) => link.href).slice(0, 4);
const introHighlights = cv.summary.slice(0, 2);

const formatDate = (date: Date) =>
  date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });

const formatHost = (href: string) => {
  try {
    return new URL(href).hostname.replace('www.', '');
  } catch {
    return href;
  }
};
---

<BaseLayout title="Home">
  <section class="hero-grid">
    <article class="card hero-card">
      <p class="pill">Welcome</p>
      <h1>{profile.name}</h1>
      <p class="lede">
        {profile.headline} focused on Java platforms, carefully built UIs, and
        steady delivery for enterprise teams.
      </p>
      <p class="hero-meta">Based in {profile.location}.</p>
      <ul class="summary-list">
        {introHighlights.map((item) => (
          <li>{item}</li>
        ))}
      </ul>
      <div class="cta-row">
        <a class="cta primary" href="/cv">CV</a>
        <a class="cta" href="/projects">Projects</a>
        <a class="cta" href="/blog">Blog</a>
        <a class="cta" href="/links">Links</a>
      </div>
    </article>

    <aside class="card link-card">
      <div class="section-head">
        <div>
          <p class="eyebrow">Featured links</p>
          <h2>Find me elsewhere</h2>
        </div>
        <a class="text-link" href="/links">All links</a>
      </div>
      <div class="link-list">
        {featuredLinks.map((link) => (
          <a class="link-item" href={link.href} target="_blank" rel="noreferrer">
            <span>{link.label}</span>
            <span class="link-meta">{formatHost(link.href)}</span>
          </a>
        ))}
      </div>
    </aside>
  </section>

  <section class="feature-grid">
    <article class="card">
      <div class="section-head">
        <div>
          <p class="eyebrow">Featured projects</p>
          <h2>Selected builds</h2>
        </div>
        <a class="text-link" href="/projects">View all</a>
      </div>
      <div class="feature-list">
        {featuredProjects.length ? (
          featuredProjects.map((project) => {
            const stack = project.data.stack ?? [];
            const outcomes = project.data.outcomes ?? [];

            return (
              <article class="feature-item">
                <p class="feature-meta">{project.data.role}</p>
                <h3>
                  <a href={`/projects/${project.slug}`}>{project.data.title}</a>
                </h3>
                {stack.length ? (
                  <ul class="stack">
                    {stack.slice(0, 4).map((tool) => (
                      <li>{tool}</li>
                    ))}
                  </ul>
                ) : null}
                {outcomes.length ? (
                  <ul class="highlight-list">
                    {outcomes.slice(0, 2).map((outcome) => (
                      <li>{outcome}</li>
                    ))}
                  </ul>
                ) : null}
              </article>
            );
          })
        ) : (
          <p class="empty">New projects are on the way.</p>
        )}
      </div>
    </article>

    <article class="card">
      <div class="section-head">
        <div>
          <p class="eyebrow">Featured posts</p>
          <h2>Latest writing</h2>
        </div>
        <a class="text-link" href="/blog">View all</a>
      </div>
      <div class="feature-list">
        {featuredPosts.length ? (
          featuredPosts.map((post) => (
            <article class="feature-item">
              <p class="feature-meta">
                {formatDate(post.data.date)} Â· {post.data.tags.join(', ')}
              </p>
              <h3>
                <a href={`/blog/${post.slug}`}>{post.data.title}</a>
              </h3>
              <p class="feature-body">{post.data.description}</p>
            </article>
          ))
        ) : (
          <p class="empty">Fresh notes coming soon.</p>
        )}
      </div>
    </article>
  </section>

  <style>
    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 1.5rem;
      align-items: start;
    }

    .hero-card h1 {
      margin: 0.6rem 0 0.4rem;
      font-size: clamp(2.3rem, 4vw, 3.2rem);
    }

    .lede {
      margin: 0 0 0.6rem;
      color: var(--ink-soft);
      font-size: 1.05rem;
    }

    .hero-meta {
      margin: 0 0 1rem;
      color: var(--ink-soft);
      font-size: 0.95rem;
    }

    .summary-list {
      margin: 0;
      padding-left: 1.2rem;
      display: grid;
      gap: 0.4rem;
    }

    .cta-row {
      margin-top: 1.4rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .cta {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1.1rem;
      border-radius: 999px;
      border: 1px solid rgba(61, 40, 20, 0.2);
      font-size: 0.95rem;
      color: var(--ink);
      background: rgba(255, 255, 255, 0.7);
      transition: transform 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .cta:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
    }

    .cta.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
    }

    .cta.primary:hover {
      color: #fff;
      background: var(--accent-strong);
    }

    .section-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .eyebrow {
      margin: 0 0 0.35rem;
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--ink-soft);
    }

    .text-link {
      font-size: 0.9rem;
      color: var(--accent);
    }

    .link-card {
      position: sticky;
      top: 1.5rem;
    }

    .link-list {
      display: grid;
      gap: 0.75rem;
    }

    .link-item {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      align-items: center;
      padding: 0.75rem 0.9rem;
      border-radius: 16px;
      border: 1px solid rgba(61, 40, 20, 0.16);
      background: rgba(255, 255, 255, 0.6);
      transition: border-color 0.2s ease, transform 0.2s ease;
    }

    .link-item:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .link-meta {
      font-size: 0.8rem;
      color: var(--ink-soft);
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .feature-list {
      display: grid;
      gap: 1.5rem;
    }

    .feature-item {
      padding-bottom: 1.1rem;
      border-bottom: 1px solid rgba(195, 91, 45, 0.18);
    }

    .feature-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .feature-meta {
      margin: 0;
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--ink-soft);
    }

    .feature-item h3 {
      margin: 0.5rem 0 0.6rem;
      font-size: 1.3rem;
    }

    .feature-body {
      margin: 0;
      color: var(--ink-soft);
    }

    .stack {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0;
      margin: 0.75rem 0 0.75rem;
      font-size: 0.9rem;
    }

    .stack li {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(61, 40, 20, 0.2);
      color: var(--ink-soft);
    }

    .highlight-list {
      margin: 0;
      padding-left: 1.2rem;
      color: var(--ink-soft);
    }

    .empty {
      margin: 0;
      color: var(--ink-soft);
    }

    @media (max-width: 900px) {
      .hero-grid {
        grid-template-columns: 1fr;
      }

      .link-card {
        position: static;
      }
    }

    @media (max-width: 760px) {
      .feature-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>
